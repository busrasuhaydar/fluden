<!DOCTYPE html>
<html lang="en">
<head>
    <title>busfluid</title>
    <style>
        body {
            margin: 0;
            background-color: #000;
            color: #fff;
            font-family: Helvetica, Arial, sans-serif;
            overflow: hidden; /* disable scrolling / rubberband effect on mobile */
            height:100vh;
        }

        canvas {
            display: block;
            position: absolute;
            outline:0;
        }

        * {
            /* disable on touch highlights of html elements, especially on mobile! */
            -webkit-tap-highlight-color: transparent;
            -webkit-touch-callout: none;
            -webkit-user-select: none;
            -moz-user-select: none;
            -ms-user-select: none;
            user-select: none;
        }

    </style>

    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width, user-scalable=no, initial-scale=1">
    <meta itemprop="name" content="busfluid">
    <meta itemprop="description" content="made with cables">
    <meta itemprop="image" content="screenshot.png">
    <meta name="description" content="made with cables"/>

</head>
<body>
    <canvas id="glcanvas" width="100vw" height="100vh" tabindex="1"></canvas>

    
    <script type="text/javascript" src="js/patch.js" async></script>
    

    <script type="text/javascript">

        // 🎹 PIANO RENK SİSTEMİ - SplatColor kullan
        let fluidPatch = null;

        function showError(initiator,...args)
        {
            CABLES.logErrorConsole("[" + initiator + "]", ...args);
        }

        function patchInitialized(patch)
        {
            // Patch'i global olarak sakla
            fluidPatch = patch;
            
            // SplatColor başlat (Array [R, G, B] formatında, 0-1 normalize)
            patch.setVariable('SplatColor', [0.5, 0.5, 0.8]);
            
            console.log('✅ Cables patch hazır - SplatColor sistemi aktif!');
            console.log('📋 Mevcut variable\'lar:', Object.keys(patch.config.variables || {}));
        }

        function patchFinishedLoading(patch)
        {
            // Canvas'ı tam ekran yap
            resizeCanvas();
            
            console.log('🎨 Fluid yüklendi, piano mesajları bekleniyor...');
        }

        // Canvas tam ekran - AGRESIF
        function resizeCanvas() {
            const canvas = document.getElementById('glcanvas');
            const w = window.innerWidth;
            const h = window.innerHeight;
            
            canvas.width = w;
            canvas.height = h;
            canvas.style.cssText = `
                position: fixed !important;
                top: 0 !important;
                left: 0 !important;
                width: ${w}px !important;
                height: ${h}px !important;
                display: block !important;
            `;
            
            console.log('📐 Canvas FORCED:', w, 'x', h);
            
            // Cables'e resize event gönder
            if (typeof CABLES !== 'undefined' && CABLES.patch) {
                window.dispatchEvent(new Event('resize'));
            }
        }

        window.addEventListener('resize', resizeCanvas);
        window.addEventListener('load', () => {
            resizeCanvas();
            setTimeout(resizeCanvas, 100);
            setTimeout(resizeCanvas, 500);
            setTimeout(resizeCanvas, 1000);
        });

        // 🎹 PİYANODAN MESAJ ALICI
        window.addEventListener('message', (event) => {
            if (event.data.type === 'pianoKeyPress') {
                const colors = event.data.colors;
                const key = event.data.key;
                const x = event.data.x || window.innerWidth / 2;
                const y = event.data.y || window.innerHeight / 2;
                
                if (!colors || colors.length === 0) return;
                
                // İlk rengi kullan
                const color = colors[0];
                
                console.log('🎨', key.toUpperCase(), '→', `rgb(${color.r},${color.g},${color.b})`);
                
                // SplatColor'ı güncelle - ARRAY formatında [R, G, B] 0-1 normalize
                if (fluidPatch) {
                    const normalizedColor = [
                        color.r / 255,
                        color.g / 255,
                        color.b / 255
                    ];
                    
                    fluidPatch.setVariable('SplatColor', normalizedColor);
                    
                    // Mouse pozisyonunu ayarla (0-1 normalize)
                    const normalizedX = x / window.innerWidth;
                    const normalizedY = 1.0 - (y / window.innerHeight); // Y'yi ters çevir
                    
                    fluidPatch.setVariable('MousePosX', normalizedX);
                    fluidPatch.setVariable('MousePosY', normalizedY);
                    
                    // Mouse force ve drag
                    fluidPatch.setVariable('MouseSplatForce', 8000); // Güçlü efekt
                    fluidPatch.setVariable('SplatRadius', 0.25);
                    fluidPatch.setVariable('MouseIsDragged', 1);
                    fluidPatch.setVariable('mouseButtonDown', 1);
                    
                    console.log('✅ Fluid tetiklendi:', normalizedX.toFixed(2), normalizedY.toFixed(2));
                    
                    // Spiral hareket - DAHA GÜÇLÜ
                    createSpiralEffect(normalizedX, normalizedY, normalizedColor);
                    
                    // Mouse up
                    setTimeout(() => {
                        if (fluidPatch) {
                            fluidPatch.setVariable('MouseIsDragged', 0);
                            fluidPatch.setVariable('mouseButtonDown', 0);
                        }
                    }, 500);
                }
            }
        });

        // Spiral efekt oluştur - GÜÇLÜ
        function createSpiralEffect(startX, startY, color) {
            let angle = 0;
            let radius = 0;
            let step = 0;
            const maxSteps = 30;
            
            const spiralInterval = setInterval(() => {
                angle += 0.6;
                radius += 0.012;
                
                const x = startX + Math.cos(angle) * radius;
                const y = startY + Math.sin(angle) * radius;
                
                if (fluidPatch) {
                    fluidPatch.setVariable('MousePosX', Math.max(0, Math.min(1, x)));
                    fluidPatch.setVariable('MousePosY', Math.max(0, Math.min(1, y)));
                    fluidPatch.setVariable('SplatColor', color);
                    fluidPatch.setVariable('MouseSplatForce', 8000);
                    fluidPatch.setVariable('MouseIsDragged', 1);
                }
                
                step++;
                if (step > maxSteps) {
                    clearInterval(spiralInterval);
                }
            }, 20);
        }

        document.addEventListener("CABLES.jsLoaded", function (event)
        {
            CABLES.patch = new CABLES.Patch({
                patch: CABLES.exportedPatch,
                "prefixAssetPath": "",
                "assetPath": "assets/",
                "jsPath": "js/",
                "glCanvasId": "glcanvas",
                "glCanvasResizeToWindow": true,
                "onError": showError,
                "onPatchLoaded": patchInitialized,
                "onFinishedLoading": patchFinishedLoading,
                "canvas": {"alpha":true, "premultipliedAlpha":true } // make canvas transparent
            });
        });

        // disable rubberband effect on mobile devices
        document.getElementById('glcanvas').addEventListener('touchmove', (e)=>{ e.preventDefault(); }, false);
    </script>
</body>
</html>
