<!DOCTYPE html>
<html lang="en">
<head>
    <title>Piano Fluid - FINAL SOLUTION</title>
    <style>
        body {
            margin: 0;
            background-color: #000;
            color: #fff;
            font-family: Helvetica, Arial, sans-serif;
            overflow: hidden;
            height: 100vh;
        }

        canvas {
            display: block;
            position: absolute;
            outline: 0;
        }

        * {
            -webkit-tap-highlight-color: transparent;
            -webkit-touch-callout: none;
            -webkit-user-select: none;
            -moz-user-select: none;
            -ms-user-select: none;
            user-select: none;
        }
    </style>

    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width, user-scalable=no, initial-scale=1">
</head>
<body>
    <canvas id="glcanvas" width="100vw" height="100vh" tabindex="1"></canvas>

    <script type="text/javascript" src="js/patch.js" async></script>

    <script type="text/javascript">

        let patchReady = false;

        function showError(initiator,...args) {
            // Silent
        }

        function patchInitialized(patch) {
            patchReady = true;
            console.log('✅ Cables patch hazır!');
            
            // Test: SplatColor variable'ı var mı?
            setTimeout(() => {
                try {
                    const testColor = patch.getVariable('SplatColor');
                    console.log('📋 Mevcut SplatColor:', testColor);
                } catch(e) {
                    console.warn('⚠️ SplatColor variable bulunamadı!');
                }
            }, 1000);
        }

        function patchFinishedLoading(patch) {
            console.log('🎨 Fluid yüklendi!');
        }

        // 🎹 PİYANO MESAJ SİSTEMİ - ULTRA RENKLI!
        window.addEventListener('message', (event) => {
            if (event.data.type === 'pianoKeyPress') {
                const colors = event.data.colors || [];
                const key = event.data.key;
                const x = event.data.x || window.innerWidth / 2;
                const y = event.data.y || window.innerHeight / 2;
                
                if (colors.length === 0) return;
                
                console.log('🎹', key.toUpperCase(), '→', colors.length, 'renk!');
                
                // ANA RENK: Merkez spiral
                applyPianoColor(colors[0]);
                simulatePianoInput(x, y);
                
                // EK RENKLER: Çevrede patlamalar (5-7 renk)
                const extraColors = colors.slice(1, 8);
                extraColors.forEach((color, i) => {
                    setTimeout(() => {
                        const angle = (i / extraColors.length) * Math.PI * 2;
                        const dist = 80 + Math.random() * 40;
                        const newX = x + Math.cos(angle) * dist;
                        const newY = y + Math.sin(angle) * dist;
                        
                        applyPianoColor(color);
                        simulatePianoInput(newX, newY);
                    }, (i + 1) * 100);
                });
            }
        });

        // PNG rengini Cables'e gönder - TÜM YÖNTEMLER DENENİYOR
        function applyPianoColor(color) {
            if (!patchReady || typeof CABLES === 'undefined' || !CABLES.patch) {
                console.warn('⚠️ Patch henüz hazır değil!');
                return;
            }

            const normalizedColor = [
                color.r / 255,
                color.g / 255,
                color.b / 255
            ];

            try {
                // YÖNTEM 1: SplatColor variable
                CABLES.patch.setVariable('SplatColor', normalizedColor);
                console.log('✅ SplatColor set:', normalizedColor.map(v => v.toFixed(2)).join(', '));
            } catch(e) {
                console.warn('⚠️ SplatColor set hatası:', e.message);
            }

            // YÖNTEM 2: pianoColorR/G/B (varsa)
            try {
                CABLES.patch.setVariable('pianoColorR', color.r);
                CABLES.patch.setVariable('pianoColorG', color.g);
                CABLES.patch.setVariable('pianoColorB', color.b);
                console.log('✅ pianoColor RGB set');
            } catch(e) {
                // Sessiz fail - bu variable'lar olmayabilir
            }

            // YÖNTEM 3: Normalized RGB (varsa)
            try {
                CABLES.patch.setVariable('pianoColorR', normalizedColor[0]);
                CABLES.patch.setVariable('pianoColorG', normalizedColor[1]);
                CABLES.patch.setVariable('pianoColorB', normalizedColor[2]);
            } catch(e) {
                // Sessiz fail
            }
        }

        // Mouse simülasyonu - SPIRAL HAREKET
        function simulatePianoInput(startX, startY) {
            const canvas = document.getElementById('glcanvas');
            if (!canvas) {
                console.warn('⚠️ Canvas bulunamadı!');
                return;
            }

            // Mouse down
            canvas.dispatchEvent(new MouseEvent('mousedown', {
                clientX: startX,
                clientY: startY,
                button: 0,
                buttons: 1,
                bubbles: true,
                cancelable: true
            }));

            console.log('🖱️ Mouse down:', startX, startY);

            // Spiral hareket
            let angle = 0;
            let radius = 0;
            let step = 0;
            const maxSteps = 35;

            const spiralInterval = setInterval(() => {
                angle += 0.65;
                radius += 3.5;

                const x = startX + Math.cos(angle) * radius;
                const y = startY + Math.sin(angle) * radius;

                // Mouse move
                canvas.dispatchEvent(new MouseEvent('mousemove', {
                    clientX: x,
                    clientY: y,
                    button: 0,
                    buttons: 1,
                    bubbles: true,
                    cancelable: true
                }));

                step++;
                if (step >= maxSteps || radius > 200) {
                    clearInterval(spiralInterval);

                    // Mouse up
                    canvas.dispatchEvent(new MouseEvent('mouseup', {
                        clientX: x,
                        clientY: y,
                        button: 0,
                        buttons: 0,
                        bubbles: true,
                        cancelable: true
                    }));

                    console.log('✅ Spiral tamamlandı');
                }
            }, 16);
        }

        document.addEventListener("CABLES.jsLoaded", function (event) {
            CABLES.patch = new CABLES.Patch({
                patch: CABLES.exportedPatch,
                "prefixAssetPath": "",
                "assetPath": "assets/",
                "jsPath": "js/",
                "glCanvasId": "glcanvas",
                "glCanvasResizeToWindow": true,
                "onError": showError,
                "onPatchLoaded": patchInitialized,
                "onFinishedLoading": patchFinishedLoading,
                "canvas": {"alpha":true, "premultipliedAlpha":true }
            });
        });

        document.getElementById('glcanvas').addEventListener('touchmove', (e)=>{ e.preventDefault(); }, false);
    </script>
</body>
</html>
