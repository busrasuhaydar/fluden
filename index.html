<!DOCTYPE html>
<html lang="en">
<head>
    <title>Piano Fluid - Enhanced</title>
    <style>
        * {
            margin: 0 !important;
            padding: 0 !important;
            -webkit-tap-highlight-color: transparent;
            -webkit-touch-callout: none;
            -webkit-user-select: none;
            -moz-user-select: none;
            -ms-user-select: none;
            user-select: none;
            box-sizing: border-box;
        }

        html, body {
            width: 100vw !important;
            height: 100vh !important;
            overflow: hidden !important;
            background-color: #000;
            color: #fff;
            font-family: Helvetica, Arial, sans-serif;
            position: fixed;
            top: 0;
            left: 0;
        }

        canvas {
            display: block;
            position: fixed !important;
            top: 0 !important;
            left: 0 !important;
            width: 100% !important;
            height: 100% !important;
            min-width: 100vw !important;
            min-height: 100vh !important;
            outline: 0;
        }
        
        #glcanvas {
            width: 100vw !important;
            height: 100vh !important;
        }

        /* FPS/CPU yazÄ±larÄ±nÄ± gizle */
        div[style*="position: absolute"],
        div[style*="fixed"],
        .cables-stats,
        .stats-panel {
            display: none !important;
            visibility: hidden !important;
        }

    </style>

    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width, user-scalable=no, initial-scale=1">
</head>
<body>
    <canvas id="glcanvas" tabindex="1" style="width:100vw;height:100vh;"></canvas>

    <script type="text/javascript" src="js/patch.js" async></script>

    <script type="text/javascript">

        function showError(initiator,...args) {
            // Silent
        }

        function patchInitialized(patch) {
            console.log('âœ… Fluid hazÄ±r!');
            hideStatsPanels();
        }

        function patchFinishedLoading(patch) {
            console.log('ðŸŽ¨ YÃ¼kleme tamamlandÄ±!');
            hideStatsPanels();
        }

        // FPS/CPU panellerini gizle
        function hideStatsPanels() {
            setTimeout(() => {
                const statsDivs = document.querySelectorAll('div');
                statsDivs.forEach(div => {
                    const style = div.getAttribute('style');
                    if (style && (style.includes('position: absolute') || style.includes('position: fixed'))) {
                        div.style.display = 'none';
                        div.style.visibility = 'hidden';
                    }
                });
            }, 100);
        }

        // ðŸŽ¨ COLORS ARRAY'Ä°NDEN EN BELÄ°RGÄ°N RENKLERÄ° SEÃ‡
        function selectBestColors(colors) {
            if (!colors || colors.length === 0) {
                return [{r: 255, g: 100, b: 200}];
            }

            // 1. Ã‡ok koyu/aÃ§Ä±k/gri renkleri filtrele
            const vibrantColors = colors.filter(c => {
                const brightness = (c.r + c.g + c.b) / 3;
                const saturation = Math.max(c.r, c.g, c.b) - Math.min(c.r, c.g, c.b);
                
                // Ã‡ok koyu, Ã§ok aÃ§Ä±k veya gri deÄŸilse kabul et
                return brightness > 30 && brightness < 230 && saturation > 20;
            });

            // EÄŸer filtreleme sonrasÄ± hiÃ§ renk kalmadÄ±ysa orijinali kullan
            const workingColors = vibrantColors.length > 0 ? vibrantColors : colors;

            // 2. En belirgin 10 rengi seÃ§ (doygunluÄŸa gÃ¶re sÄ±rala)
            const sortedByVibrance = [...workingColors].sort((a, b) => {
                const satA = Math.max(a.r, a.g, a.b) - Math.min(a.r, a.g, a.b);
                const satB = Math.max(b.r, b.g, b.b) - Math.min(b.r, b.g, b.b);
                return satB - satA;
            });

            const top10 = sortedByVibrance.slice(0, 10);

            // 3. Her renk iÃ§in varyasyonlar ekle
            const finalColors = [];
            top10.forEach(color => {
                // Orijinal
                finalColors.push(color);
                
                // Parlak varyasyon
                finalColors.push({
                    r: Math.min(255, Math.round(color.r * 1.3)),
                    g: Math.min(255, Math.round(color.g * 1.3)),
                    b: Math.min(255, Math.round(color.b * 1.3))
                });
                
                // Koyu varyasyon
                finalColors.push({
                    r: Math.max(0, Math.round(color.r * 0.7)),
                    g: Math.max(0, Math.round(color.g * 0.7)),
                    b: Math.max(0, Math.round(color.b * 0.7))
                });
            });

            // En fazla 20 renk dÃ¶ndÃ¼r
            return finalColors.slice(0, 20);
        }

        // ðŸŽ¹ PÄ°YANO MESAJ SÄ°STEMÄ°
        window.addEventListener('message', (event) => {
            if (event.data.type === 'pianoKeyPress') {
                const colors = event.data.colors || [];
                const key = event.data.key;
                
                if (colors.length === 0) return;
                
                // En belirgin 20 rengi al
                const bestColors = selectBestColors(colors);
                
                // Random bir renk seÃ§
                const randomColor = bestColors[Math.floor(Math.random() * bestColors.length)];
                
                console.log('ðŸŽ¹', key.toUpperCase(), 'â†’', `rgb(${randomColor.r},${randomColor.g},${randomColor.b})`);
                
                // Rengi Cables'e gÃ¶nder
                setPianoColor(randomColor);
                
                // HER TUÅžTA FARKLI NOKTADA OLUÅžTUR
                const randomX = Math.random() * window.innerWidth;
                const randomY = Math.random() * window.innerHeight;
                
                createPianoSpiral(randomX, randomY);
            }
        });

        // PNG rengini Cables SplatColor'a set et
        function setPianoColor(color) {
            if (typeof CABLES === 'undefined' || !CABLES.patch) return;
            
            try {
                const normalizedColor = [
                    color.r / 255,
                    color.g / 255,
                    color.b / 255
                ];
                CABLES.patch.setVariable('SplatColor', normalizedColor);
            } catch(e) {
                console.warn('Renk set hatasÄ±');
            }
        }

        // Spiral mouse hareketi
        function createPianoSpiral(startX, startY) {
            const canvas = document.getElementById('glcanvas');
            if (!canvas) return;
            
            canvas.dispatchEvent(new MouseEvent('mousedown', {
                clientX: startX,
                clientY: startY,
                button: 0,
                buttons: 1,
                bubbles: true
            }));
            
            let angle = 0;
            let radius = 0;
            let step = 0;
            const maxSteps = 30;
            
            const interval = setInterval(() => {
                angle += 0.6;
                radius += 3;
                
                const x = startX + Math.cos(angle) * radius;
                const y = startY + Math.sin(angle) * radius;
                
                canvas.dispatchEvent(new MouseEvent('mousemove', {
                    clientX: x,
                    clientY: y,
                    button: 0,
                    buttons: 1,
                    bubbles: true
                }));
                
                step++;
                if (step >= maxSteps) {
                    clearInterval(interval);
                    
                    canvas.dispatchEvent(new MouseEvent('mouseup', {
                        clientX: x,
                        clientY: y,
                        button: 0,
                        buttons: 0,
                        bubbles: true
                    }));
                }
            }, 16);
        }

        document.addEventListener("CABLES.jsLoaded", function (event) {
            // Canvas boyutlarÄ±nÄ± zorla ayarla
            const canvas = document.getElementById('glcanvas');
            canvas.width = window.innerWidth;
            canvas.height = window.innerHeight;
            
            CABLES.patch = new CABLES.Patch({
                patch: CABLES.exportedPatch,
                "prefixAssetPath": "",
                "assetPath": "assets/",
                "jsPath": "js/",
                "glCanvasId": "glcanvas",
                "glCanvasResizeToWindow": true,
                "onError": showError,
                "onPatchLoaded": patchInitialized,
                "onFinishedLoading": patchFinishedLoading,
                "canvas": {"alpha":true, "premultipliedAlpha":true }
            });
            
            hideStatsPanels();
            
            // Pencere boyutu deÄŸiÅŸince yeniden ayarla
            window.addEventListener('resize', () => {
                canvas.width = window.innerWidth;
                canvas.height = window.innerHeight;
            });
        });

        document.getElementById('glcanvas').addEventListener('touchmove', (e)=>{ e.preventDefault(); }, false);
        
        // Periyodik olarak stats panellerini kontrol et
        setInterval(hideStatsPanels, 1000);
    </script>
</body>
</html>
