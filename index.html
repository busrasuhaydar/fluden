<!DOCTYPE html>
<html lang="en">
<head>
    <title>Piano Fluid - FINAL SOLUTION</title>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        html, body {
            width: 100vw !important;
            height: 100vh !important;
            background-color: #000;
            overflow: hidden;
            position: fixed;
            top: 0;
            left: 0;
        }

        canvas {
            display: block;
            position: fixed !important;
            top: 0 !important;
            left: 0 !important;
            width: 100vw !important;
            height: 100vh !important;
            outline: 0;
            z-index: 1;
        }

        /* HİÇBİR YAZI GÖRÜNMESIN - ULTRA AGRESIF */
        div:not(#root):not(#glcanvas), 
        span, p, h1, h2, h3, h4, h5, h6, a, label, button, strong, em,
        [class*="fps"], [class*="cpu"], [class*="gpu"], [class*="info"],
        [class*="stats"], [class*="debug"], [class*="performance"],
        [class*="cables"], [id*="stats"], [id*="info"], [id*="fps"],
        [id*="debug"], [id*="performance"], [data-*="stats"] {
            display: none !important;
            visibility: hidden !important;
            opacity: 0 !important;
            pointer-events: none !important;
            position: absolute !important;
            left: -9999px !important;
            top: -9999px !important;
            width: 0 !important;
            height: 0 !important;
            overflow: hidden !important;
            z-index: -9999 !important;
        }

        * {
            -webkit-tap-highlight-color: transparent;
            -webkit-touch-callout: none;
            -webkit-user-select: none;
            -moz-user-select: none;
            -ms-user-select: none;
            user-select: none;
        }
    </style>

    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width, user-scalable=no, initial-scale=1">
</head>
<body>
    <canvas id="glcanvas" width="100vw" height="100vh" tabindex="1"></canvas>

    <script type="text/javascript" src="js/patch.js" async></script>

    <script type="text/javascript">

        let patchReady = false;

        function showError(initiator,...args) {
            // Silent
        }

        function patchInitialized(patch) {
            patchReady = true;
            console.log('✅ Cables patch hazır!');
            
            // FORCE FULLSCREEN
            forceFullscreen();
            
            // HİÇBİR YAZI GÖRÜNMESIN
            hideAllText();
            setInterval(hideAllText, 100); // Her 100ms kontrol et
            
            // Test: SplatColor variable'ı var mı?
            setTimeout(() => {
                try {
                    const testColor = patch.getVariable('SplatColor');
                    console.log('📋 SplatColor hazır');
                } catch(e) {
                    console.warn('⚠️ SplatColor variable bulunamadı!');
                }
            }, 1000);
        }

        function forceFullscreen() {
            const canvas = document.getElementById('glcanvas');
            if (!canvas) return;
            
            // Gerçek window boyutları
            const w = window.innerWidth;
            const h = window.innerHeight;
            
            // Canvas pixel boyutları - RETINA desteği
            const dpr = window.devicePixelRatio || 1;
            canvas.width = w * dpr;
            canvas.height = h * dpr;
            
            // Canvas CSS boyutları - TAM EKRAN GARANTİSİ
            canvas.style.cssText = `
                position: fixed !important;
                top: 0 !important;
                left: 0 !important;
                right: 0 !important;
                bottom: 0 !important;
                width: 100vw !important;
                height: 100vh !important;
                max-width: 100vw !important;
                max-height: 100vh !important;
                min-width: 100vw !important;
                min-height: 100vh !important;
                display: block !important;
                z-index: 1 !important;
                margin: 0 !important;
                padding: 0 !important;
                border: 0 !important;
                outline: 0 !important;
            `;
            
            // HTML ve BODY - TAM EKRAN GARANTİSİ
            document.documentElement.style.cssText = `
                width: 100vw !important;
                height: 100vh !important;
                overflow: hidden !important;
                position: fixed !important;
                top: 0 !important;
                left: 0 !important;
                margin: 0 !important;
                padding: 0 !important;
            `;
            
            document.body.style.cssText = `
                width: 100vw !important;
                height: 100vh !important;
                overflow: hidden !important;
                position: fixed !important;
                top: 0 !important;
                left: 0 !important;
                margin: 0 !important;
                padding: 0 !important;
            `;
            
            console.log('🖼️ TAM EKRAN:', w, 'x', h, '(DPR:', dpr + ')');
        }

        function hideAllText() {
            // TÜM text elementlerini gizle - ULTRA AGRESIF
            const selectors = [
                'div', 'span', 'p', 'h1', 'h2', 'h3', 'h4', 'h5', 'h6', 
                'a', 'label', 'button', 'strong', 'em', 'b', 'i', 'u',
                'small', 'pre', 'code', 'blockquote', 'ul', 'ol', 'li',
                'table', 'tr', 'td', 'th', 'caption', 'dl', 'dt', 'dd',
                'article', 'section', 'nav', 'aside', 'header', 'footer',
                'figure', 'figcaption', 'time', 'mark', 'q', 'cite', 'abbr',
                '[class*="fps"]', '[class*="cpu"]', '[class*="gpu"]', 
                '[class*="info"]', '[class*="stats"]', '[class*="debug"]',
                '[class*="cables"]', '[class*="text"]', '[class*="label"]',
                '[id*="stats"]', '[id*="info"]', '[id*="fps"]', '[id*="debug"]'
            ];
            
            document.querySelectorAll(selectors.join(', ')).forEach(el => {
                // Canvas ve root hariç HERŞEYİ gizle
                if (el.id !== 'root' && 
                    el.id !== 'glcanvas' && 
                    el.tagName.toLowerCase() !== 'canvas' &&
                    !el.closest('canvas')) {
                    el.style.cssText = `
                        display: none !important;
                        visibility: hidden !important;
                        opacity: 0 !important;
                        pointer-events: none !important;
                        position: absolute !important;
                        left: -9999px !important;
                        width: 0 !important;
                        height: 0 !important;
                        overflow: hidden !important;
                    `;
                }
            });
        }

        window.addEventListener('resize', forceFullscreen);
        window.addEventListener('load', () => {
            forceFullscreen();
            hideAllText();
            setTimeout(forceFullscreen, 100);
            setTimeout(forceFullscreen, 500);
        });

        function patchFinishedLoading(patch) {
            console.log('🎨 Fluid yüklendi!');
        }

        // 🎹 PİYANO MESAJ SİSTEMİ - ULTRA RENKLI + RANDOM POZİSYON!
        window.addEventListener('message', (event) => {
            if (event.data.type === 'pianoKeyPress') {
                const colors = event.data.colors || [];
                const key = event.data.key;
                
                // RANDOM POZİSYON - Her tuş farklı yerde başlıyor!
                const x = Math.random() * window.innerWidth;
                const y = Math.random() * window.innerHeight;
                
                if (colors.length === 0) return;
                
                console.log('🎹', key.toUpperCase(), '→', colors.length, 'renk!');
                
                // ANA RENK: Merkez spiral
                applyPianoColor(colors[0]);
                simulatePianoInput(x, y);
                
                // EK RENKLER: Çevrede patlamalar (5-7 renk)
                const extraColors = colors.slice(1, 8);
                extraColors.forEach((color, i) => {
                    setTimeout(() => {
                        const angle = (i / extraColors.length) * Math.PI * 2;
                        const dist = 80 + Math.random() * 40;
                        const newX = x + Math.cos(angle) * dist;
                        const newY = y + Math.sin(angle) * dist;
                        
                        applyPianoColor(color);
                        simulatePianoInput(newX, newY);
                    }, (i + 1) * 100);
                });
            }
        });

        // PNG rengini Cables'e gönder - ULTRA BELİRGİN DOMINANT COLORS 🎨
        function applyPianoColor(color) {
            if (!patchReady || typeof CABLES === 'undefined' || !CABLES.patch) {
                return;
            }

            let r = color.r;
            let g = color.g;
            let b = color.b;
            
            // ═══════════════════════════════════════════════════
            // 1. DOMINANT COLOR EXTRACTION - En belirgin kanalı bul ve PATLATMALI
            // ═══════════════════════════════════════════════════
            const maxChannel = Math.max(r, g, b);
            const minChannel = Math.min(r, g, b);
            const saturation = maxChannel === 0 ? 0 : (maxChannel - minChannel) / maxChannel;
            
            // Eğer renk soluksa (düşük saturation), dominant kanalı ULTRA BOOST
            if (saturation < 0.5) {
                if (r === maxChannel) {
                    r = Math.min(255, r * 2.8);  // Kırmızı dominant
                    g = Math.max(0, g * 0.3);
                    b = Math.max(0, b * 0.3);
                } else if (g === maxChannel) {
                    g = Math.min(255, g * 2.8);  // Yeşil dominant
                    r = Math.max(0, r * 0.3);
                    b = Math.max(0, b * 0.3);
                } else {
                    b = Math.min(255, b * 2.8);  // Mavi dominant
                    r = Math.max(0, r * 0.3);
                    g = Math.max(0, g * 0.3);
                }
            } else {
                // Zaten doygun renkler için daha hafif boost
                if (r === maxChannel) {
                    r = Math.min(255, r * 1.4);
                } else if (g === maxChannel) {
                    g = Math.min(255, g * 1.4);
                } else {
                    b = Math.min(255, b * 1.4);
                }
            }
            
            // ═══════════════════════════════════════════════════
            // 2. BRIGHTNESS BOOST - Minimum 150 parlaklık garantisi
            // ═══════════════════════════════════════════════════
            const brightness = (r + g + b) / 3;
            if (brightness < 150) {
                const factor = 150 / Math.max(brightness, 1);
                r = Math.min(255, r * factor);
                g = Math.min(255, g * factor);
                b = Math.min(255, b * factor);
            }
            
            // ═══════════════════════════════════════════════════
            // 3. SATURATION MEGA BOOST - Renkleri daha canlı yap
            // ═══════════════════════════════════════════════════
            const newMax = Math.max(r, g, b);
            const avg = (r + g + b) / 3;
            
            if (newMax > 0) {
                const boostFactor = 3.2; // ÇOK AGRESIF BOOST
                r = Math.min(255, Math.max(0, avg + (r - avg) * boostFactor));
                g = Math.min(255, Math.max(0, avg + (g - avg) * boostFactor));
                b = Math.min(255, Math.max(0, avg + (b - avg) * boostFactor));
            }
            
            // ═══════════════════════════════════════════════════
            // 4. CONTRAST ULTRA BOOST - Siyah/beyaz ayrımını artır
            // ═══════════════════════════════════════════════════
            const contrastFactor = 1.6;
            r = Math.min(255, Math.max(0, ((r / 255 - 0.5) * contrastFactor + 0.5) * 255));
            g = Math.min(255, Math.max(0, ((g / 255 - 0.5) * contrastFactor + 0.5) * 255));
            b = Math.min(255, Math.max(0, ((b / 255 - 0.5) * contrastFactor + 0.5) * 255));
            
            // ═══════════════════════════════════════════════════
            // 5. GAMMA CORRECTION - Renkleri görsel olarak daha canlı göster
            // ═══════════════════════════════════════════════════
            const gamma = 0.75;
            r = Math.pow(r / 255, gamma) * 255;
            g = Math.pow(g / 255, gamma) * 255;
            b = Math.pow(b / 255, gamma) * 255;
            
            // ═══════════════════════════════════════════════════
            // 6. VIBRANCE BOOST - Son rötuş
            // ═══════════════════════════════════════════════════
            const finalMax = Math.max(r, g, b);
            if (finalMax < 200) {
                const vibranceFactor = 1.3;
                r = Math.min(255, r * vibranceFactor);
                g = Math.min(255, g * vibranceFactor);
                b = Math.min(255, b * vibranceFactor);
            }

            const normalizedColor = [
                r / 255,
                g / 255,
                b / 255
            ];

            // TÜM YÖNTEMLER DENENİYOR
            try {
                CABLES.patch.setVariable('SplatColor', normalizedColor);
                console.log('🎨 SÜPER BELİRGİN RENK:', Math.round(r), Math.round(g), Math.round(b));
            } catch(e) {}

            try {
                CABLES.patch.setVariable('pianoColorR', normalizedColor[0]);
                CABLES.patch.setVariable('pianoColorG', normalizedColor[1]);
                CABLES.patch.setVariable('pianoColorB', normalizedColor[2]);
            } catch(e) {}

            try {
                CABLES.patch.setVariable('colorR', normalizedColor[0]);
                CABLES.patch.setVariable('colorG', normalizedColor[1]);
                CABLES.patch.setVariable('colorB', normalizedColor[2]);
            } catch(e) {}
            
            try {
                CABLES.patch.setVariable('color', normalizedColor);
            } catch(e) {}
        }

        // Mouse simülasyonu - SPIRAL HAREKET
        function simulatePianoInput(startX, startY) {
            const canvas = document.getElementById('glcanvas');
            if (!canvas) {
                console.warn('⚠️ Canvas bulunamadı!');
                return;
            }

            // Mouse down
            canvas.dispatchEvent(new MouseEvent('mousedown', {
                clientX: startX,
                clientY: startY,
                button: 0,
                buttons: 1,
                bubbles: true,
                cancelable: true
            }));

            console.log('🖱️ Mouse down:', startX, startY);

            // Spiral hareket
            let angle = 0;
            let radius = 0;
            let step = 0;
            const maxSteps = 35;

            const spiralInterval = setInterval(() => {
                angle += 0.65;
                radius += 3.5;

                const x = startX + Math.cos(angle) * radius;
                const y = startY + Math.sin(angle) * radius;

                // Mouse move
                canvas.dispatchEvent(new MouseEvent('mousemove', {
                    clientX: x,
                    clientY: y,
                    button: 0,
                    buttons: 1,
                    bubbles: true,
                    cancelable: true
                }));

                step++;
                if (step >= maxSteps || radius > 200) {
                    clearInterval(spiralInterval);

                    // Mouse up
                    canvas.dispatchEvent(new MouseEvent('mouseup', {
                        clientX: x,
                        clientY: y,
                        button: 0,
                        buttons: 0,
                        bubbles: true,
                        cancelable: true
                    }));

                    console.log('✅ Spiral tamamlandı');
                }
            }, 16);
        }

        document.addEventListener("CABLES.jsLoaded", function (event) {
            CABLES.patch = new CABLES.Patch({
                patch: CABLES.exportedPatch,
                "prefixAssetPath": "",
                "assetPath": "assets/",
                "jsPath": "js/",
                "glCanvasId": "glcanvas",
                "glCanvasResizeToWindow": true,
                "onError": showError,
                "onPatchLoaded": patchInitialized,
                "onFinishedLoading": patchFinishedLoading,
                "canvas": {"alpha":true, "premultipliedAlpha":true }
            });
        });

        document.getElementById('glcanvas').addEventListener('touchmove', (e)=>{ e.preventDefault(); }, false);
    </script>
</body>
</html>
