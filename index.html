<!DOCTYPE html>
<html lang="en">
<head>
    <title>busfluid</title>
    <style>
        body {
            margin: 0;
            background-color: #000;
            color: #fff;
            font-family: Helvetica, Arial, sans-serif;
            overflow: hidden; /* disable scrolling / rubberband effect on mobile */
            height:100vh;
        }

        canvas {
            display: block;
            position: absolute;
            outline:0;
        }

        * {
            /* disable on touch highlights of html elements, especially on mobile! */
            -webkit-tap-highlight-color: transparent;
            -webkit-touch-callout: none;
            -webkit-user-select: none;
            -moz-user-select: none;
            -ms-user-select: none;
            user-select: none;
        }

    </style>

    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width, user-scalable=no, initial-scale=1">
    <meta itemprop="name" content="busfluid">
    <meta itemprop="description" content="made with cables">
    <meta itemprop="image" content="screenshot.png">
    <meta name="description" content="made with cables"/>

</head>
<body>
    <canvas id="glcanvas" width="100vw" height="100vh" tabindex="1"></canvas>

    
    <script type="text/javascript" src="js/patch.js" async></script>
    

    <script type="text/javascript">

        // 🎹 PIANO RENK SİSTEMİ - SplatColor kullan
        let fluidPatch = null;

        function showError(initiator,...args)
        {
            CABLES.logErrorConsole("[" + initiator + "]", ...args);
        }

        function patchInitialized(patch)
        {
            // Patch'i global olarak sakla
            fluidPatch = patch;
            
            // SplatColor başlat (Array [R, G, B] formatında, 0-1 normalize)
            patch.setVariable('SplatColor', [0.5, 0.5, 0.8]);
            
            console.log('✅ Cables patch hazır - SplatColor sistemi aktif!');
            console.log('📋 Mevcut variable\'lar:', Object.keys(patch.config.variables || {}));
        }

        function patchFinishedLoading(patch)
        {
            // Canvas'ı tam ekran yap
            resizeCanvas();
            
            console.log('🎨 Fluid yüklendi, piano mesajları bekleniyor...');
        }

        // Canvas tam ekran - AGRESIF
        function resizeCanvas() {
            const canvas = document.getElementById('glcanvas');
            if (!canvas) return;
            
            const w = window.innerWidth;
            const h = window.innerHeight;
            
            canvas.width = w;
            canvas.height = h;
            canvas.style.cssText = `
                position: fixed !important;
                top: 0 !important;
                left: 0 !important;
                width: ${w}px !important;
                height: ${h}px !important;
                display: block !important;
            `;
            
            console.log('📐 Canvas:', w, 'x', h);
        }

        window.addEventListener('resize', resizeCanvas);
        window.addEventListener('load', () => {
            resizeCanvas();
            setTimeout(resizeCanvas, 100);
            setTimeout(resizeCanvas, 500);
            setTimeout(resizeCanvas, 1000);
        });

        // 🎹 PİYANODAN MESAJ ALICI
        window.addEventListener('message', (event) => {
            if (event.data.type === 'pianoKeyPress') {
                const colors = event.data.colors;
                const key = event.data.key;
                const x = event.data.x || window.innerWidth / 2;
                const y = event.data.y || window.innerHeight / 2;
                
                if (!colors || colors.length === 0) return;
                
                // İlk rengi kullan
                const color = colors[0];
                
                console.log('🎹', key.toUpperCase(), '→', `rgb(${color.r},${color.g},${color.b})`);
                
                // SplatColor'ı güncelle
                if (fluidPatch) {
                    const normalizedColor = [
                        color.r / 255,
                        color.g / 255,
                        color.b / 255
                    ];
                    
                    try {
                        fluidPatch.setVariable('SplatColor', normalizedColor);
                    } catch(e) {
                        console.warn('SplatColor set failed:', e);
                    }
                    
                    // Mouse pozisyonu (0-1 normalize, Y ters)
                    const normalizedX = x / window.innerWidth;
                    const normalizedY = 1.0 - (y / window.innerHeight);
                    
                    // Mouse drag başlat
                    startMouseDrag(normalizedX, normalizedY, normalizedColor);
                }
            }
        });

        // Mouse drag simülasyonu - ORİJİNAL GİBİ
        function startMouseDrag(startX, startY, color) {
            if (!fluidPatch) return;
            
            // Başlangıç
            fluidPatch.setVariable('MousePosX', startX);
            fluidPatch.setVariable('MousePosY', startY);
            fluidPatch.setVariable('mouseButtonDown', 1);
            fluidPatch.setVariable('MouseIsDragged', 1);
            
            // Drag pozisyonları
            fluidPatch.setVariable('MouseDragX', startX);
            fluidPatch.setVariable('MouseDragY', startY);
            
            console.log('🖱️ Mouse drag:', startX.toFixed(2), startY.toFixed(2));
            
            // Spiral hareket
            let angle = 0;
            let radius = 0;
            let step = 0;
            const maxSteps = 35;
            
            const dragInterval = setInterval(() => {
                angle += 0.7;
                radius += 0.018;
                
                const newX = Math.max(0, Math.min(1, startX + Math.cos(angle) * radius));
                const newY = Math.max(0, Math.min(1, startY + Math.sin(angle) * radius));
                
                if (fluidPatch) {
                    fluidPatch.setVariable('MousePosX', newX);
                    fluidPatch.setVariable('MousePosY', newY);
                    fluidPatch.setVariable('MouseDragX', newX);
                    fluidPatch.setVariable('MouseDragY', newY);
                    fluidPatch.setVariable('SplatColor', color);
                    fluidPatch.setVariable('MouseIsDragged', 1);
                }
                
                step++;
                if (step >= maxSteps) {
                    clearInterval(dragInterval);
                    
                    // Drag bitir
                    if (fluidPatch) {
                        fluidPatch.setVariable('mouseButtonDown', 0);
                        fluidPatch.setVariable('MouseIsDragged', 0);
                    }
                }
            }, 18);
        }

        document.addEventListener("CABLES.jsLoaded", function (event)
        {
            CABLES.patch = new CABLES.Patch({
                patch: CABLES.exportedPatch,
                "prefixAssetPath": "",
                "assetPath": "assets/",
                "jsPath": "js/",
                "glCanvasId": "glcanvas",
                "glCanvasResizeToWindow": true,
                "onError": showError,
                "onPatchLoaded": patchInitialized,
                "onFinishedLoading": patchFinishedLoading,
                "canvas": {"alpha":true, "premultipliedAlpha":true } // make canvas transparent
            });
        });

        // disable rubberband effect on mobile devices
        document.getElementById('glcanvas').addEventListener('touchmove', (e)=>{ e.preventDefault(); }, false);
    </script>
</body>
</html>
