<!DOCTYPE html>
<html lang="en">
<head>
    <title>busfluid - DEBUG</title>
    <style>
        body {
            margin: 0;
            background-color: #000;
            color: #fff;
            font-family: Helvetica, Arial, sans-serif;
            overflow: hidden;
            height:100vh;
        }

        canvas {
            display: block;
            position: absolute;
            outline:0;
        }

        * {
            -webkit-tap-highlight-color: transparent;
            -webkit-touch-callout: none;
            -webkit-user-select: none;
            -moz-user-select: none;
            -ms-user-select: none;
            user-select: none;
        }

        #debug-overlay {
            position: fixed;
            top: 10px;
            left: 10px;
            background: rgba(0, 0, 0, 0.9);
            color: lime;
            padding: 15px;
            font-family: 'Courier New', monospace;
            font-size: 12px;
            border: 2px solid lime;
            border-radius: 8px;
            max-width: 500px;
            z-index: 99999;
        }

        #debug-overlay h3 {
            margin: 0 0 10px 0;
            color: #fff;
        }

        #debug-overlay .log {
            margin: 3px 0;
            padding: 3px;
            border-left: 3px solid #0f0;
            padding-left: 8px;
        }

        #debug-overlay .error {
            border-left-color: #f00;
            color: #f00;
        }

        #debug-overlay .success {
            border-left-color: #0f0;
            color: #0f0;
        }

        #debug-overlay .warn {
            border-left-color: #ff0;
            color: #ff0;
        }

        #test-buttons {
            position: fixed;
            bottom: 10px;
            left: 10px;
            z-index: 99999;
        }

        .test-btn {
            background: rgba(0, 255, 0, 0.2);
            border: 2px solid #0f0;
            color: #0f0;
            padding: 10px 20px;
            margin: 5px;
            cursor: pointer;
            font-family: monospace;
            border-radius: 5px;
            transition: all 0.3s;
        }

        .test-btn:hover {
            background: rgba(0, 255, 0, 0.4);
            transform: scale(1.05);
        }

    </style>

    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width, user-scalable=no, initial-scale=1">
</head>
<body>
    <canvas id="glcanvas" width="100vw" height="100vh" tabindex="1"></canvas>

    <!-- DEBUG OVERLAY -->
    <div id="debug-overlay">
        <h3>üîç CABLES FLUID DEBUG</h3>
        <div id="debug-logs"></div>
    </div>

    <!-- TEST BUTTONS -->
    <div id="test-buttons">
        <button class="test-btn" onclick="testColor('red')">üî¥ Test Kƒ±rmƒ±zƒ±</button>
        <button class="test-btn" onclick="testColor('green')">üü¢ Test Ye≈üil</button>
        <button class="test-btn" onclick="testColor('blue')">üîµ Test Mavi</button>
        <button class="test-btn" onclick="listVariables()">üìã Variable'larƒ± Listele</button>
    </div>

    <script type="text/javascript" src="js/patch.js" async></script>

    <script type="text/javascript">
        // üé® DEBUG LOGGER
        const debugLogs = document.getElementById('debug-logs');
        let logCounter = 0;

        function addLog(message, type = 'log') {
            logCounter++;
            const logDiv = document.createElement('div');
            logDiv.className = `log ${type}`;
            logDiv.textContent = `[${logCounter}] ${new Date().toLocaleTimeString()}: ${message}`;
            debugLogs.appendChild(logDiv);
            
            // Keep only last 20 logs
            if (debugLogs.children.length > 20) {
                debugLogs.removeChild(debugLogs.firstChild);
            }
            
            // Auto scroll
            debugLogs.scrollTop = debugLogs.scrollHeight;
            
            console.log(`[${type.toUpperCase()}]`, message);
        }

        let fluidPatch = null;

        function showError(initiator,...args) {
            CABLES.logErrorConsole("[" + initiator + "]", ...args);
            addLog(`ERROR: ${initiator} - ${args.join(' ')}`, 'error');
        }

        function patchInitialized(patch) {
            fluidPatch = patch;
            addLog('‚úÖ Patch initialized!', 'success');
            
            // Test t√ºm olasƒ± variable isimlerini
            const possibleVarNames = [
                'pianoColorR', 'pianoColorG', 'pianoColorB',
                'colorR', 'colorG', 'colorB',
                'r', 'g', 'b',
                'red', 'green', 'blue',
                'MousePosX', 'MousePosY',
                'mouseX', 'mouseY',
                'posX', 'posY',
                'MouseIsDragged', 'mouseButtonDown',
                'isDragging', 'isMouseDown'
            ];

            addLog('üîç Variable'lar test ediliyor...', 'warn');
            
            possibleVarNames.forEach(varName => {
                try {
                    patch.setVariable(varName, 0.5);
                    addLog(`   ‚úì ${varName} MEVCUT`, 'success');
                } catch (e) {
                    // Variable yok, sessizce devam et
                }
            });

            addLog('üìã Mevcut variable'lar yukarƒ±da listelendi', 'warn');
        }

        function patchFinishedLoading(patch) {
            resizeCanvas();
            addLog('‚úÖ Patch loading finished!', 'success');
            addLog('üéπ Piano mesajlarƒ± bekleniyor...', 'log');
        }

        function resizeCanvas() {
            const canvas = document.getElementById('glcanvas');
            canvas.width = window.innerWidth;
            canvas.height = window.innerHeight;
            canvas.style.width = window.innerWidth + 'px';
            canvas.style.height = window.innerHeight + 'px';
            canvas.style.position = 'fixed';
            canvas.style.top = '0';
            canvas.style.left = '0';
            addLog(`üìê Canvas: ${canvas.width}x${canvas.height}`, 'log');
        }

        window.addEventListener('resize', resizeCanvas);
        window.addEventListener('load', () => {
            resizeCanvas();
            setTimeout(resizeCanvas, 100);
            setTimeout(resizeCanvas, 500);
        });

        // üéπ Pƒ∞YANODAN MESAJ ALICI
        window.addEventListener('message', (event) => {
            if (event.data.type === 'pianoKeyPress') {
                const colors = event.data.colors;
                const key = event.data.key;
                const x = event.data.x || window.innerWidth / 2;
                const y = event.data.y || window.innerHeight / 2;
                
                if (!colors || colors.length === 0) {
                    addLog(`‚ö†Ô∏è ${key}: Renk paleti bo≈ü!`, 'warn');
                    return;
                }
                
                const color = colors[0];
                addLog(`üé® ${key.toUpperCase()} ‚Üí rgb(${color.r},${color.g},${color.b})`, 'success');
                
                if (fluidPatch) {
                    // T√úM OLASI VAR ƒ∞Sƒ∞MLERƒ∞Nƒ∞ DENE
                    const variantSets = [
                        // Set 1: pianoColorR/G/B
                        () => {
                            fluidPatch.setVariable('pianoColorR', color.r / 255);
                            fluidPatch.setVariable('pianoColorG', color.g / 255);
                            fluidPatch.setVariable('pianoColorB', color.b / 255);
                        },
                        // Set 2: colorR/G/B
                        () => {
                            fluidPatch.setVariable('colorR', color.r / 255);
                            fluidPatch.setVariable('colorG', color.g / 255);
                            fluidPatch.setVariable('colorB', color.b / 255);
                        },
                        // Set 3: r/g/b
                        () => {
                            fluidPatch.setVariable('r', color.r / 255);
                            fluidPatch.setVariable('g', color.g / 255);
                            fluidPatch.setVariable('b', color.b / 255);
                        },
                        // Set 4: red/green/blue
                        () => {
                            fluidPatch.setVariable('red', color.r / 255);
                            fluidPatch.setVariable('green', color.g / 255);
                            fluidPatch.setVariable('blue', color.b / 255);
                        }
                    ];

                    // Her set'i dene
                    variantSets.forEach((setFunc, index) => {
                        try {
                            setFunc();
                            addLog(`   ‚úì Set ${index + 1} uygulandƒ±`, 'success');
                        } catch (e) {
                            // Hata varsa sessizce devam et
                        }
                    });
                    
                    // Mouse pozisyonu i√ßin de t√ºm varyasyonlarƒ± dene
                    const normalizedX = x / window.innerWidth;
                    const normalizedY = y / window.innerHeight;
                    
                    try { fluidPatch.setVariable('MousePosX', normalizedX); } catch(e) {}
                    try { fluidPatch.setVariable('MousePosY', normalizedY); } catch(e) {}
                    try { fluidPatch.setVariable('mouseX', normalizedX); } catch(e) {}
                    try { fluidPatch.setVariable('mouseY', normalizedY); } catch(e) {}
                    try { fluidPatch.setVariable('posX', normalizedX); } catch(e) {}
                    try { fluidPatch.setVariable('posY', normalizedY); } catch(e) {}
                    
                    try { fluidPatch.setVariable('MouseIsDragged', 1); } catch(e) {}
                    try { fluidPatch.setVariable('mouseButtonDown', 1); } catch(e) {}
                    try { fluidPatch.setVariable('isDragging', 1); } catch(e) {}
                    try { fluidPatch.setVariable('isMouseDown', 1); } catch(e) {}
                    
                    addLog('‚úÖ T√ºm variable kombinasyonlarƒ± denendi!', 'success');
                    
                    // Spiral efekt
                    createSpiralEffect(normalizedX, normalizedY);
                    
                    // Mouse up
                    setTimeout(() => {
                        if (fluidPatch) {
                            try { fluidPatch.setVariable('MouseIsDragged', 0); } catch(e) {}
                            try { fluidPatch.setVariable('mouseButtonDown', 0); } catch(e) {}
                            try { fluidPatch.setVariable('isDragging', 0); } catch(e) {}
                            try { fluidPatch.setVariable('isMouseDown', 0); } catch(e) {}
                        }
                    }, 300);
                } else {
                    addLog('‚ùå fluidPatch bulunamadƒ±!', 'error');
                }
            }
        });

        // Spiral efekt
        function createSpiralEffect(startX, startY) {
            let angle = 0;
            let radius = 0;
            let step = 0;
            const maxSteps = 20;
            
            const spiralInterval = setInterval(() => {
                angle += 0.4;
                radius += 0.02;
                
                const x = startX + Math.cos(angle) * radius;
                const y = startY + Math.sin(angle) * radius;
                
                if (fluidPatch) {
                    try { fluidPatch.setVariable('MousePosX', Math.max(0, Math.min(1, x))); } catch(e) {}
                    try { fluidPatch.setVariable('MousePosY', Math.max(0, Math.min(1, y))); } catch(e) {}
                    try { fluidPatch.setVariable('mouseX', Math.max(0, Math.min(1, x))); } catch(e) {}
                    try { fluidPatch.setVariable('mouseY', Math.max(0, Math.min(1, y))); } catch(e) {}
                    try { fluidPatch.setVariable('posX', Math.max(0, Math.min(1, x))); } catch(e) {}
                    try { fluidPatch.setVariable('posY', Math.max(0, Math.min(1, y))); } catch(e) {}
                }
                
                step++;
                if (step > maxSteps) {
                    clearInterval(spiralInterval);
                }
            }, 30);
        }

        // üß™ TEST FONKSƒ∞YONLARI
        function testColor(colorName) {
            addLog(`üß™ TEST: ${colorName} rengi deneniyor...`, 'warn');
            
            let r = 0, g = 0, b = 0;
            if (colorName === 'red') { r = 1; }
            if (colorName === 'green') { g = 1; }
            if (colorName === 'blue') { b = 1; }
            
            if (fluidPatch) {
                try {
                    fluidPatch.setVariable('pianoColorR', r);
                    fluidPatch.setVariable('pianoColorG', g);
                    fluidPatch.setVariable('pianoColorB', b);
                    fluidPatch.setVariable('MouseIsDragged', 1);
                    addLog(`‚úÖ ${colorName} ayarlandƒ±!`, 'success');
                    
                    setTimeout(() => {
                        fluidPatch.setVariable('MouseIsDragged', 0);
                    }, 500);
                } catch (e) {
                    addLog(`‚ùå Hata: ${e.message}`, 'error');
                }
            } else {
                addLog('‚ùå Patch hen√ºz y√ºklenmedi!', 'error');
            }
        }

        function listVariables() {
            addLog('üìã Patch variable'larƒ± listeleniyor...', 'warn');
            if (fluidPatch && fluidPatch.vars) {
                Object.keys(fluidPatch.vars).forEach(varName => {
                    addLog(`   ‚Ä¢ ${varName} = ${fluidPatch.vars[varName]}`, 'log');
                });
            } else {
                addLog('‚ùå Variable'lar bulunamadƒ±', 'error');
            }
        }

        document.addEventListener("CABLES.jsLoaded", function (event) {
            addLog('üì¶ CABLES.js y√ºklendi', 'success');
            
            CABLES.patch = new CABLES.Patch({
                patch: CABLES.exportedPatch,
                "prefixAssetPath": "",
                "assetPath": "assets/",
                "jsPath": "js/",
                "glCanvasId": "glcanvas",
                "glCanvasResizeToWindow": true,
                "onError": showError,
                "onPatchLoaded": patchInitialized,
                "onFinishedLoading": patchFinishedLoading,
                "canvas": {"alpha":true, "premultipliedAlpha":true }
            });
        });

        // Rubberband effect disable
        document.getElementById('glcanvas').addEventListener('touchmove', (e)=>{ e.preventDefault(); }, false);

        addLog('üöÄ Sistem ba≈ülatƒ±ldƒ±', 'success');
    </script>
</body>
</html>
