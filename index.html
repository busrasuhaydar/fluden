<!DOCTYPE html>
<html lang="en">
<head>
    <title>busfluid</title>
    <style>
        body {
            margin: 0;
            background-color: #000;
            color: #fff;
            font-family: Helvetica, Arial, sans-serif;
            overflow: hidden;
            height:100vh;
        }

        canvas {
            display: block;
            position: absolute;
            outline:0;
        }

        * {
            -webkit-tap-highlight-color: transparent;
            -webkit-touch-callout: none;
            -webkit-user-select: none;
            -moz-user-select: none;
            -ms-user-select: none;
            user-select: none;
        }

        /* DEBUG PANEL */
        #debug-panel {
            position: fixed;
            top: 10px;
            left: 10px;
            background: rgba(0, 0, 0, 0.9);
            color: lime;
            padding: 15px;
            font-family: monospace;
            font-size: 11px;
            border: 2px solid lime;
            border-radius: 5px;
            max-height: 400px;
            overflow-y: auto;
            z-index: 99999;
            min-width: 300px;
        }

        #debug-panel h3 {
            margin: 0 0 10px 0;
            color: #fff;
            font-size: 14px;
        }

        .log {
            margin: 3px 0;
            padding: 3px 5px;
            border-left: 3px solid #0f0;
        }

        .error { border-left-color: #f00; color: #f00; }
        .success { border-left-color: #0f0; color: #0f0; }
        .warn { border-left-color: #ff0; color: #ff0; }

    </style>

    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width, user-scalable=no, initial-scale=1">
    <meta itemprop="name" content="busfluid">
    <meta itemprop="description" content="made with cables">
</head>
<body>
    <canvas id="glcanvas" width="100vw" height="100vh" tabindex="1"></canvas>

    <!-- DEBUG PANEL -->
    <div id="debug-panel">
        <h3>üîç FLUID DEBUG</h3>
        <div id="debug-logs"></div>
    </div>

    <script type="text/javascript" src="js/patch.js" async></script>

    <script type="text/javascript">
        // DEBUG LOGGER
        const debugLogs = document.getElementById('debug-logs');
        let logCount = 0;

        function addLog(message, type = 'log') {
            logCount++;
            const log = document.createElement('div');
            log.className = `log ${type}`;
            log.textContent = `[${logCount}] ${message}`;
            debugLogs.appendChild(log);
            
            if (debugLogs.children.length > 30) {
                debugLogs.removeChild(debugLogs.firstChild);
            }
            
            debugLogs.scrollTop = debugLogs.scrollHeight;
            console.log(`[${type.toUpperCase()}]`, message);
        }

        let fluidPatch = null;

        function showError(initiator,...args) {
            CABLES.logErrorConsole("[" + initiator + "]", ...args);
            addLog(`ERROR: ${initiator} - ${args.join(' ')}`, 'error');
        }

        function patchInitialized(patch) {
            fluidPatch = patch;
            addLog('‚úÖ Patch initialized!', 'success');
            
            // Test variable'larƒ±
            patch.setVariable('pianoColorR', 0.5);
            patch.setVariable('pianoColorG', 0.5);
            patch.setVariable('pianoColorB', 0.5);
            
            addLog('‚úÖ Default variables set', 'success');
        }

        function patchFinishedLoading(patch) {
            resizeCanvas();
            addLog('‚úÖ Patch loading finished!', 'success');
            addLog('üéπ Listening for piano messages...', 'log');
        }

        function resizeCanvas() {
            const canvas = document.getElementById('glcanvas');
            canvas.width = window.innerWidth;
            canvas.height = window.innerHeight;
            canvas.style.width = window.innerWidth + 'px';
            canvas.style.height = window.innerHeight + 'px';
            canvas.style.position = 'fixed';
            canvas.style.top = '0';
            canvas.style.left = '0';
        }

        window.addEventListener('resize', resizeCanvas);
        window.addEventListener('load', () => {
            resizeCanvas();
            setTimeout(resizeCanvas, 100);
            setTimeout(resizeCanvas, 500);
        });

        // üéπ Pƒ∞YANO MESAJ Dƒ∞NLEYƒ∞Cƒ∞Sƒ∞
        let messageReceived = 0;
        
        window.addEventListener('message', (event) => {
            messageReceived++;
            addLog(`üì® Message #${messageReceived} received from: ${event.origin}`, 'log');
            
            if (event.data && event.data.type === 'pianoKeyPress') {
                const colors = event.data.colors;
                const key = event.data.key;
                const x = event.data.x || window.innerWidth / 2;
                const y = event.data.y || window.innerHeight / 2;
                
                addLog(`üéπ Piano key: ${key.toUpperCase()}`, 'success');
                
                if (!colors || colors.length === 0) {
                    addLog('‚ö†Ô∏è No colors in message!', 'warn');
                    return;
                }
                
                const color = colors[0];
                addLog(`üé® Color: rgb(${color.r},${color.g},${color.b})`, 'log');
                
                if (fluidPatch) {
                    try {
                        // Renkleri ayarla
                        fluidPatch.setVariable('pianoColorR', color.r / 255);
                        fluidPatch.setVariable('pianoColorG', color.g / 255);
                        fluidPatch.setVariable('pianoColorB', color.b / 255);
                        
                        addLog('‚úÖ Colors set!', 'success');
                        
                        // Mouse pozisyonu
                        const normalizedX = x / window.innerWidth;
                        const normalizedY = y / window.innerHeight;
                        
                        fluidPatch.setVariable('MousePosX', normalizedX);
                        fluidPatch.setVariable('MousePosY', normalizedY);
                        fluidPatch.setVariable('MouseIsDragged', 1);
                        fluidPatch.setVariable('mouseButtonDown', 1);
                        
                        addLog('‚úÖ Mouse position set!', 'success');
                        
                        // Force ve radius (eƒüer varsa)
                        if (event.data.force) {
                            try {
                                fluidPatch.setVariable('splatForce', event.data.force);
                                addLog(`‚úÖ Force set: ${event.data.force}`, 'success');
                            } catch(e) {
                                addLog('‚ö†Ô∏è splatForce variable not found', 'warn');
                            }
                        }
                        
                        if (event.data.radius) {
                            try {
                                fluidPatch.setVariable('splatRadius', event.data.radius);
                                addLog(`‚úÖ Radius set: ${event.data.radius}`, 'success');
                            } catch(e) {
                                addLog('‚ö†Ô∏è splatRadius variable not found', 'warn');
                            }
                        }
                        
                        // Mouse up
                        setTimeout(() => {
                            if (fluidPatch) {
                                fluidPatch.setVariable('MouseIsDragged', 0);
                                fluidPatch.setVariable('mouseButtonDown', 0);
                            }
                        }, 300);
                        
                    } catch (error) {
                        addLog(`‚ùå Error setting variables: ${error.message}`, 'error');
                    }
                } else {
                    addLog('‚ùå fluidPatch not found!', 'error');
                }
            } else {
                addLog(`‚ÑπÔ∏è Unknown message type: ${event.data ? event.data.type : 'no type'}`, 'log');
            }
        });

        document.addEventListener("CABLES.jsLoaded", function (event) {
            addLog('üì¶ CABLES.js loaded', 'success');
            
            CABLES.patch = new CABLES.Patch({
                patch: CABLES.exportedPatch,
                "prefixAssetPath": "",
                "assetPath": "assets/",
                "jsPath": "js/",
                "glCanvasId": "glcanvas",
                "glCanvasResizeToWindow": true,
                "onError": showError,
                "onPatchLoaded": patchInitialized,
                "onFinishedLoading": patchFinishedLoading,
                "canvas": {"alpha":true, "premultipliedAlpha":true }
            });
        });

        document.getElementById('glcanvas').addEventListener('touchmove', (e)=>{ e.preventDefault(); }, false);

        addLog('üöÄ System initialized', 'success');
        addLog('üëÇ Listening for messages...', 'log');
    </script>
</body>
</html>
