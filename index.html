<!DOCTYPE html>
<html lang="en">
<head>
    <title>busfluid</title>
    <style>
        body {
            margin: 0;
            background-color: #000;
            color: #fff;
            font-family: Helvetica, Arial, sans-serif;
            overflow: hidden; /* disable scrolling / rubberband effect on mobile */
            height:100vh;
        }

        canvas {
            display: block;
            position: absolute;
            outline:0;
        }

        * {
            /* disable on touch highlights of html elements, especially on mobile! */
            -webkit-tap-highlight-color: transparent;
            -webkit-touch-callout: none;
            -webkit-user-select: none;
            -moz-user-select: none;
            -ms-user-select: none;
            user-select: none;
        }

    </style>

    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width, user-scalable=no, initial-scale=1">
    <meta itemprop="name" content="busfluid">
    <meta itemprop="description" content="made with cables">
    <meta itemprop="image" content="screenshot.png">
    <meta name="description" content="made with cables"/>

</head>
<body>
    <canvas id="glcanvas" width="100vw" height="100vh" tabindex="1"></canvas>

    
    <script type="text/javascript" src="js/patch.js" async></script>
    

    <script type="text/javascript">

        // üéπ PIANO RENK Sƒ∞STEMƒ∞ - Global deƒüi≈ükenler
        let fluidPatch = null;

        function showError(initiator,...args)
        {
            CABLES.logErrorConsole("[" + initiator + "]", ...args);
        }

        function patchInitialized(patch)
        {
            // Patch'i global olarak sakla
            fluidPatch = patch;
            
            // Variable'larƒ± ba≈ülat (0-255 deƒüil, 0-1 aralƒ±ƒüƒ±nda olabilir!)
            patch.setVariable('pianoColorR', 0.5);
            patch.setVariable('pianoColorG', 0.5);
            patch.setVariable('pianoColorB', 0.5);
            
            console.log('‚úÖ Cables patch hazƒ±r - Piano renk sistemi aktif!');
        }

        function patchFinishedLoading(patch)
        {
            // Canvas'ƒ± tam ekran yap
            resizeCanvas();
            
            console.log('üé® Fluid y√ºklendi, piano mesajlarƒ± bekleniyor...');
        }

        // Canvas tam ekran
        function resizeCanvas() {
            const canvas = document.getElementById('glcanvas');
            canvas.width = window.innerWidth;
            canvas.height = window.innerHeight;
            canvas.style.width = window.innerWidth + 'px';
            canvas.style.height = window.innerHeight + 'px';
            canvas.style.position = 'fixed';
            canvas.style.top = '0';
            canvas.style.left = '0';
            console.log('üìê Canvas:', canvas.width, 'x', canvas.height);
        }

        window.addEventListener('resize', resizeCanvas);
        window.addEventListener('load', () => {
            resizeCanvas();
            setTimeout(resizeCanvas, 100);
            setTimeout(resizeCanvas, 500);
            setTimeout(resizeCanvas, 1000);
        });

        // üéπ Pƒ∞YANODAN MESAJ ALICI
        window.addEventListener('message', (event) => {
            if (event.data.type === 'pianoKeyPress') {
                const colors = event.data.colors;
                const key = event.data.key;
                const x = event.data.x || window.innerWidth / 2;
                const y = event.data.y || window.innerHeight / 2;
                
                if (!colors || colors.length === 0) return;
                
                // ƒ∞lk rengi kullan
                const color = colors[0];
                
                console.log('üé®', key.toUpperCase(), '‚Üí', `rgb(${color.r},${color.g},${color.b})`);
                
                // Cables variable'larƒ±nƒ± g√ºncelle (0-1 aralƒ±ƒüƒ±na normalize et)
                if (fluidPatch) {
                    fluidPatch.setVariable('pianoColorR', color.r / 255);
                    fluidPatch.setVariable('pianoColorG', color.g / 255);
                    fluidPatch.setVariable('pianoColorB', color.b / 255);
                    
                    // Mouse pozisyonunu ayarla (0-1 normalize)
                    const normalizedX = x / window.innerWidth;
                    const normalizedY = y / window.innerHeight;
                    
                    fluidPatch.setVariable('MousePosX', normalizedX);
                    fluidPatch.setVariable('MousePosY', normalizedY);
                    
                    // Mouse drag sim√ºle et
                    fluidPatch.setVariable('MouseIsDragged', 1);
                    fluidPatch.setVariable('mouseButtonDown', 1);
                    
                    // Spiral hareket
                    createSpiralEffect(normalizedX, normalizedY);
                    
                    // Mouse up
                    setTimeout(() => {
                        if (fluidPatch) {
                            fluidPatch.setVariable('MouseIsDragged', 0);
                            fluidPatch.setVariable('mouseButtonDown', 0);
                        }
                    }, 300);
                }
            }
        });

        // Spiral efekt olu≈ütur
        function createSpiralEffect(startX, startY) {
            let angle = 0;
            let radius = 0;
            let step = 0;
            const maxSteps = 20;
            
            const spiralInterval = setInterval(() => {
                angle += 0.4;
                radius += 0.02;
                
                const x = startX + Math.cos(angle) * radius;
                const y = startY + Math.sin(angle) * radius;
                
                if (fluidPatch) {
                    fluidPatch.setVariable('MousePosX', Math.max(0, Math.min(1, x)));
                    fluidPatch.setVariable('MousePosY', Math.max(0, Math.min(1, y)));
                }
                
                step++;
                if (step > maxSteps) {
                    clearInterval(spiralInterval);
                }
            }, 30);
        }

        document.addEventListener("CABLES.jsLoaded", function (event)
        {
            CABLES.patch = new CABLES.Patch({
                patch: CABLES.exportedPatch,
                "prefixAssetPath": "",
                "assetPath": "assets/",
                "jsPath": "js/",
                "glCanvasId": "glcanvas",
                "glCanvasResizeToWindow": true,
                "onError": showError,
                "onPatchLoaded": patchInitialized,
                "onFinishedLoading": patchFinishedLoading,
                "canvas": {"alpha":true, "premultipliedAlpha":true } // make canvas transparent
            });
        });

        // disable rubberband effect on mobile devices
        document.getElementById('glcanvas').addEventListener('touchmove', (e)=>{ e.preventDefault(); }, false);
// üé® Pƒ∞YANODAN MESAJ ALICI - EKLENMƒ∞≈û VERSƒ∞YON
window.addEventListener('message', (event) => {
    console.log('üì® Mesaj alƒ±ndƒ±:', event.data);
    
    if (event.data.type === 'pianoKeyPress') {
        const colors = event.data.colors;
        const key = event.data.key;
        const x = event.data.x || window.innerWidth / 2;
        const y = event.data.y || window.innerHeight / 2;
        
        if (!colors || colors.length === 0) {
            console.warn('‚ö†Ô∏è Renk paleti bo≈ü!');
            return;
        }
        
        const color = colors[0];
        console.log('üé®', key.toUpperCase(), '‚Üí', `rgb(${color.r},${color.g},${color.b})`);
        
        if (fluidPatch) {
            // Renkleri 0-1 aralƒ±ƒüƒ±na normalize et
            fluidPatch.setVariable('pianoColorR', color.r / 255);
            fluidPatch.setVariable('pianoColorG', color.g / 255);
            fluidPatch.setVariable('pianoColorB', color.b / 255);
            
            // Mouse pozisyonu
            const normalizedX = x / window.innerWidth;
            const normalizedY = y / window.innerHeight;
            
            fluidPatch.setVariable('MousePosX', normalizedX);
            fluidPatch.setVariable('MousePosY', normalizedY);
            fluidPatch.setVariable('MouseIsDragged', 1);
            fluidPatch.setVariable('mouseButtonDown', 1);
            
            console.log('‚úÖ Fluid variables g√ºncellendi!');
            
            setTimeout(() => {
                if (fluidPatch) {
                    fluidPatch.setVariable('MouseIsDragged', 0);
                    fluidPatch.setVariable('mouseButtonDown', 0);
                }
            }, 300);
        } else {
            console.error('‚ùå fluidPatch bulunamadƒ±!');
        }
    }
});

console.log('üéπ Piano mesaj dinleyicisi aktif!');
        
    </script>
</body>
</html>
